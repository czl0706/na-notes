## 安全性設定

[TOC]

### Fail2ban
<https://newtoypia.blogspot.com/2016/04/fail2ban.html>
<https://net.nthu.edu.tw/netsys/security:fail2ban>
```bash
    apt install fail2ban
    cd /etc/fail2ban
    cp jail.conf jail.local

    service fail2ban restart
    fail2ban-client status (table)
    fail2ban-client set sshd unbanip 83.136.253.43
```

設定檔:
```bash
    [DEFAULT]

    ignoreip = 127.0.0.1/8 999.999.999.0/24 888.888.888.0/24
    enabled  = true # 啟用 SSH
    maxretry = 10 # 登入失敗幾次封鎖
    bantime  = 14400 # 封鎖的時間，單位:秒 -1表示永久封鎖
    findtime = 600 # 在多久的時間內，單位:秒，600=10分鐘
    
    filter   = sshd
    action   = iptables[name=SSH, port=ssh, protocol=tcp]
    logpath  = /var/log/secure # Log 檔的位置
    
    
    [sshd]
    # To use more aggressive sshd modes set filter parameter "mode" in jail.local:
    # normal (default), ddos, extra or aggressive (combines all).
    # See "tests/files/logs/sshd" or "filter.d/sshd.conf" for usage example and details.
    #mode   = normal
    enabled = true
    filter = sshd
    port    = ssh
    logpath = %(sshd_log)s
    backend = %(sshd_backend)s
    maxretry = 3
    bantime = 30
```

[Link to Tutorial](http://www.vixual.net/blog/archives/252)

### iptables

Rules ⊂ Chain ⊂ Table

Filter table 負責過濾==進入主機==或==離開主機==、還有經過主機做==forward==的封包。
NAT table 負責進行==NAT==，也就是==更改source IP/port或destination IP/port==。

Rule 包含 accept, drop, reject, return

<https://gigenchang.wordpress.com/2014/04/19/10%E5%88%86%E9%90%98%E5%AD%B8%E6%9C%83iptables/>

```sh
    iptables [-t Table] -L -n
    ip6tables
    # -t 沒打預設為filter table
    # -L list -n 避開DNS反查

    iptables -A [chain] [-s 來源] [-d 目的地] [-p 協定] […..還有很多自己man] [-j 套用的rule]
    iptables -D {match rule}

    # -A some_chain : append rule到某個chain的最後面
    # -I some_chain  : Insert rule到某個chain的最前面
    # -I some_chain 3: Insert rule到某個chain的第三個rule

    # -s 來源：source IP, 來源的格式可以是 192.168.1.1或是192.168.1.1/24，也可以是 -s ! source，這會排除所有source
    # -d 目的地

    # -p 協定：協定可以是tcp, udp, icmp

    # –dport port：match TCP或UDP封包的port，port的格式可以是 –dport 80或是 –dport 80:90
    # –sport port：同上

    # -j rule，這裡的rule其實是「target of rule」，也就是你可以是一個chain_name，或是「ACCEPT, DROP, QUEUE, RETURN, REJECT, LOG, DNAT, SNAT」

    apt install iptables-persistent
    #iptables-save > /etc/iptables/rules.v4
    dpkg-reconfigure iptables-persistent
    networkfilter-persistent save
    # /etc/ufw/after.rules if ufw enabled

    ls /lib/modules/{TAB}/kernel/net/netfilter # show available modules

    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # !!
```

#### NAT(PAT)

```bash
    vim /etc/sysctl.conf # net.ipv4.ip_forward=1
    sysctl -p

    iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE
```

#### DMZ

##### 規則

1. 內網可以訪問外網
內網的用戶顯然需要自由地訪問外網。在這一策略中，防火牆需要進行源位址轉換。

2. 內網可以訪問DMZ
此策略是為了方便內網用戶使用和管理DMZ中的伺服器。

3. 外網不能訪問內網
很顯然，內網中存放的是公司內部資料，這些資料不允許外網的用戶進行訪問。

4. 外網可以訪問DMZ
DMZ中的伺服器本身就是要給外界提供服務的，所以外網必須可以訪問DMZ。同時，外網訪問DMZ需要由防火牆完成對外位址到伺服器實際位址的轉換。

5. DMZ不能訪問內網
很明顯，如果違背此策略，則當入侵者攻陷DMZ時，就可以進一步進攻到內網的重要資料。

6. DMZ不能訪問外網
此條策略也有例外，比如DMZ中放置郵件伺服器時，就需要訪問外網，否則將不能正常工作。

tl;dr: `內網`可以訪問`所有區域`, `外網`可以訪問`DMZ`, `DMZ`不能訪問`任何區域`(如有特殊服務則例外)



- a example for DMZ server 
```bash
    vim /etc/sysctl.conf # net.ipv4.ip_forward=1
    sysctl -p

#   eth0: internal      eth1: dmz       eth2: external
#   192.168.0.254       192.168.1.254   192.168.3.254

#   root@debian:~# iptables-save

    # Generated by xtables-save v1.8.2 on Sat Sep  5 02:24:33 2020
    *filter
    :INPUT ACCEPT [34797:2382874]
    :FORWARD DROP [18:6064]
    :OUTPUT DROP [110:15381]
    -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
    -A FORWARD -i eth0 -j ACCEPT
    -A FORWARD -i eth2 -o eth1 -j ACCEPT
    -A FORWARD -i eth1 -p tcp -m tcp --dport 53 -j ACCEPT
    -A FORWARD -i eth1 -p udp -m udp --dport 53 -j ACCEPT
    -A FORWARD -s 192.168.2.0/24 -d 192.168.0.0/24 -j ACCEPT
    -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
    -A OUTPUT -o lo -j ACCEPT
    COMMIT
    # Completed on Sat Sep  5 02:24:33 2020
    # Generated by xtables-save v1.8.2 on Sat Sep  5 02:24:33 2020
    *nat
    :PREROUTING ACCEPT [397:35619]
    :INPUT ACCEPT [71:14515]
    :POSTROUTING ACCEPT [4605:320452]
    :OUTPUT ACCEPT [4433:304376]
    -A PREROUTING -d 192.168.3.254/32 -p tcp -m multiport --dports 53,80,443 -j DNAT --to-destination 192.168.1.1
    -A PREROUTING -d 192.168.3.254/32 -p udp -m multiport --dports 53,500,4500 -j DNAT --to-destination 192.168.1.1
    -A POSTROUTING -s 192.168.1.1/32 -p tcp -m multiport --sports 53,80,443 -j SNAT --to-source 192.168.3.254
    -A POSTROUTING -s 192.168.1.1/32 -p udp -m multiport --sports 53,500,4500 -j SNAT --to-source 192.168.3.254
    -A POSTROUTING -o eth2 -j MASQUERADE
    COMMIT
    # Completed on Sat Sep  5 02:24:33 2020
    # Generated by xtables-save v1.8.2 on Sat Sep  5 02:24:33 2020
    *mangle
    :PREROUTING ACCEPT [37730:2835856]
    :INPUT ACCEPT [34797:2382874]
    :FORWARD ACCEPT [2885:449541]
    :OUTPUT ACCEPT [35188:2431438]
    :POSTROUTING ACCEPT [37888:2857072]
    -A PREROUTING ! -d 192.168.3.254/32 -i eth2 -j DROP
    COMMIT
    # Completed on Sat Sep  5 02:24:33 2020
```

#### Misc
```bash
    iptables -P INPUT DROP/ACCEPT
    iptables -t nat -A PREROUTING  -i eth0 -p tcp --dport 222 -j DNAT --to-destination 192.168.2.1:22
    iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
    
# iprange
    iptables -A INPUT -p tcp --dport 22 -m iprange --src-range 192.168.1.100-192.168.1.200 -j REJECT

# redirect
    iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8000
    
# multiport
    iptables -A INPUT -p tcp -m multiport --dports 1024:3000 -j ACCEPT

    netstat -tuln # show ports in use

# load balancing (statistic)
    iptables -A PREROUTING -t nat -p tcp -d 192.168.1.1 --dport 27017 \
         -m statistic --mode nth --every 3 --packet 0              \
         -j DNAT --to-destination 10.0.0.2:1234
    iptables -A PREROUTING -t nat -p tcp -d 192.168.1.1 --dport 27017 \
            -m statistic --mode nth --every 2 --packet 0              \
            -j DNAT --to-destination 10.0.0.3:1234
    iptables -A PREROUTING -t nat -p tcp -d 192.168.1.1 --dport 27017 \
            -j DNAT --to-destination 10.0.0.4:1234

# hashlimit (for bandwidth limit and connection limit/time)
    # https://blog.csdn.net/eydwyz/article/details/53382786
    iptables -A OUTPUT -p tcp --sport 445 -m hashlimit --hashlimit-above 5mb/sec --hashlimit-burst 10mb --hashlimit-name bwlimit -j DROP

    iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -m hashlimit --hashlimit-above 2/min --hashlimit-burst 2 --hashlimit-name sshlimit -j DROP

# connlimit (limit max parallel connections)
    # https://dotblogs.com.tw/ghoseliang/2012/10/05/75289
    iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m connlimit --connlimit-above 2 -j DROP

# log drop
    # https://ishm.idv.tw/?p=192
    iptables -N LOG_DROP
    iptables -A LOG_DROP -j LOG --log-prefix "iptables dropped:"
    iptables -A LOG_DROP -j DROP


    iptables -A INPUT -j LOG_DROP
    vim /etc/rsyslog.conf
        # :msg, contains, "iptables dropped:" /var/log/iptables.log

# recent (limit max connection/time)
    # https://www.cnblogs.com/kevingrace/p/10008487.html
    iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH
    iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP





    
# rate limit (not recommended)
    iptables -A FORWARD -m limit -d 208.8.14.53 --limit 700/s --limit-burst 100 -j ACCEPT

    iptables -j DNAT -h
    iptables -p icmp -h

    # iptables -A INPUT -p tcp -s 193.180.177.13 -m state --syn --state NEW --dport 22 -m limit --limit 1/minute --limit-burst 1 -j ACCEPT
    # iptables -A INPUT -p tcp -s 193.180.177.13 -m state --syn --state NEW --dport 22 -j DROP
```

### VPN Forwarding Ports

- PPTP: `tcp 1723`
    ```bash
        vim /etc/sysctl.conf
            # net.netfilter.nf_conntrack_helper=1
        sysctl -p
        modprobe ip_nat_pptp
    ```
- L2TP: not suggested on servers thru NAT
- SSTP: `tcp 443`
- IKEv2: `udp 500,4500`
- DirectAccess:
    1. DirectAccess server is on the IPv4 Internet:

        Teredo traffic—User Datagram Protocol (UDP) port `3544`
        6to4 traffic—`Protocol 41` inbound and outbound
        IP-HTTPS—Transmission Control Protocol (TCP) port `443`

    2. DirectAccess server is on the IPv6 Internet:

        `Protocol 50`
        UDP port `500`
        Internet Control Message Protocol for IPv6 (`ICMPv6`) traffic

### service port list reference

[Wikipedia](https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers)
[Well-Known TCP/IP Port Numbers, Service Names & Protocols [Quick Reference]](http://www.meridianoutpost.com/resources/articles/well-known-tcpip-ports.php)

### nftables
<https://wiki.nftables.org/wiki-nftables/index.php/Quick_reference-nftables_in_10_minutes>

<https://www.hi-linux.com/posts/29206.html#nftables-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C>
<https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)>
```bash
    apt install nftables

# enable nftables
    systemctl enable nftables.service

    nft --handle list ruleset 

    nft list chain inet filter_tab input_chain

    nft list table filter_tab # deletes only when the tab is clear

    # ip ip6 inet arp bridge
    nft add/delete/flush table inet filter_tab
    nft add chain inet filter_tab input_chain \
        '{ type filter hook input priority 0; policy accept; }'

    nft chain inet mytable input { policy drop \; } # set policy to drop 

    # type filter/nat/route
    # hook prerouting/forward/input/output/postrouting
    # priority 0
    # policy accept/drop/reject  /queue/continue/return

    # nft {add/insert/replace/delete} rule \
	#	 [<family>] <table> <chain> <matches> <statements> 
    nft add/insert rule filter_tab input_chain tcp dport ssh drop 
    nft add rule inet mytable input tcp dport { http, nfs, ssh } accept

    #
    # matches:
    # ip6         :  ipv6 
    # ip          :  ipv4 
    # tcp         :  tcp 
    # udp         :  udp 
    # icmp
    # icmpv6
    # ether       :  ethernet
    # dst
    # ct          :  连接状态
    # 

    #
    # hbh
    # mh
    # rt            
    # vlan        :  vlan
    # arp         :  arp协议
    # meta        :  报文的基本信息
    # udplite     :  udp-lite 协议
    # sctp        :  sctp 协议 
    # dccp
    # ah
    # esp
    # comp
    # frag        :
    #

    nft delete rule inet filter_tab input_chain handle 2

    vim /etc/nftables.conf

# save config file
    nft list ruleset > /etc/nftables.conf
# read config file
    nft -f /etc/nftables.conf
```

```bash
    # https://wiki.nftables.org/wiki-nftables/index.php/Sets
    # https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)
    # https://wiki.nftables.org/wiki-nftables/index.php/Quick_reference-nftables_in_10_minutes
    # https://wiki.archlinux.org/index.php/Nftables

    nft list tables
    nft {add | delete |flush} table 
    nft add chain (family) {table} {name} '{type {0} hook {1} priority {2}; policy {3};}'
    # family: ip ip6 inet*
    # type: filter route nat
    # hook: prerouting input forward output postrouting

    nft {delete | list | flush} chain (family) {table} {name}
    nft rename chain (family) {table} {name} {newname}

    # set:
    nft add set ip filter blackhole { type ipv4_addr\;}
    nft add element ip filter blackhole { 192.168.1.4, 192.168.1.5 }
    nft add rule ip filter input ip saddr @blackhole drop 
    # type:
    #		ipv4_addr, ipv6_addr, inet_proto , inet_service, ifname

    nft add set nat prerouting dnat_ports '{type inet_proto tcp;}'

    nft add rule (family) {table} {chain} {matches} {statement}
    nft insert rule (family) {table} {chain} {position} {matches} {statement}
    nft delete rule (family) {table} {chain} {handle}

    # Match:
    #		ip: protocol, saddr, daddr
    #		ip6: saddr, daddr 	
    #		tcp: dport, sport 
    #		udp: dport, sport 
    # 		icmp: type {echo-reply, echo-request}
    #		icmpv6
    # 		ct: state {new, established, related}, {original | reply} {saddr | daddr}
    #		meta: iif(name), oif(name)

    # Jump-to:
    #		log: level, prefix
    # 		reject:	with icmp type net-unreachable
    #		limit: 	rate over 1023/second burst 10 packets,
    #				rate 1025 kbytes/second
    # 		nat:	dnat, snat, masquerade

    nft --handle list ruleset 
    nft list ruleset > mytables
    nft flush ruleset 
    nft -f ~/mytables
```

#### Examples

```bash
    flush ruleset

    table firewall {
        chain incoming {
            type filter hook input priority 0; policy drop;

            # established/related connections
            ct state established,related accept

            # loopback interface
            iifname lo accept

            # icmp
            icmp type echo-request accept

            # open tcp ports: sshd (22), httpd (80)
            tcp dport {ssh, http} accept
        }
    }
```

```bash
    nft add table nat 
    nft add chain nat postrouting '{type nat hook postrouting priority 100;}'
    nft add rule nat postrouting ip saddr 192.168.0.0/24 oif snat 1.2.3.4
    nft add chadin nat prerouting '{type nat hook prerouting priority -100;}'
    nft add rule nat prerouting iif eth0 tcp dport {80, 443} dnat 192.168.0.100
    nft add rule prerouting tcp dport 2222 redirect to 22

    nft add rule nat postrouting ip saddr 10.5.6.0/24 oif eth0 masquerade
```

```bash
    flush ruleset
    table ip filter {
            chain input {
                    type filter hook input priority 0; policy drop;
                    ct state { established, related } accept
                    iif "lo" accept
                    tcp dport 2222 accept
                    icmp type echo-request accept
            }

            chain forward {
                    type filter hook forward priority 0; policy accept;
            }

            chain output {
                    type filter hook output priority 0; policy accept;
            }
    }
    table ip nat {
            set dmz_ports {
                    type inet_service
                    elements = { ssh, http, https, isakmp, ipsec-nat-t }
            }

            chain prerouting {
                    type nat hook prerouting priority -100; policy accept;
                    ip daddr 192.168.0.254 tcp dport @dmz_ports dnat to 10.0.0.100
            }

            chain postrouting {
                    type nat hook postrouting priority 100; policy accept;
                    ip saddr 10.0.0.0/24 oif "ens33" masquerade
            }
    }
```







### ufw

#### Basic

```bash
    ufw enable
    ufw app list # List Available
    ufw default allow outgoing 
    ufw default deny incoming

    ufw (allow/deny/reject) ssh
    ufw allow 'WWW Full'
    ufw deny (in/out) 80{/tcp}
    ufw deny 80:85

    ufw allow from 192.168.11.0/24
    ufw deny from 192.168.11.4

    ufw deny from 192.168.11.7 to any port 22
    ufw deny from 192.168.11.7 to any app ssh

    ufw allow in | on eth0 | to any | port 80 | proto tcp

    ufw status {numbered/verbose}
    ufw delete (Number)
    ufw delete allow http
    ufw reset
```

[Link to Tutorial](https://noob.tw/ufw/)